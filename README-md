# Stage 05 â€” Argo CD + GitOps + Sealed Secrets en Minikube

## ğŸ¯ Objetivo
Implementar **GitOps** con **Argo CD**, desplegando la aplicaciÃ³n desde un repositorio GitOps, gestionando los secretos con **SealedSecrets**, y accediendo a la **interfaz UI de Argo CD** en un entorno local con **Minikube**.

---

## ğŸ§© Requisitos previos
- Minikube instalado (`minikube start`)
- `kubectl` configurado para el clÃºster local
- Acceso al repositorio GitOps (`IntroDevOps_GitOps`)
- Archivos `base/`, `overlays/dev` y `sealedsecret.yaml` correctamente definidos

---

## âš™ï¸ 1. Preparar el entorno de Minikube

Iniciar Minikube:

```bash
minikube start --driver=docker
```

Verificar que el clÃºster estÃ© corriendo:

```bash
kubectl get nodes
```

---

## ğŸŒ 2. Habilitar el add-on Ingress

Argo CD y algunos servicios (frontend/backend) pueden necesitar acceso externo.  
Activamos el **addon `ingress`** de Minikube:

```bash
minikube addons enable ingress
```

Verificar que el controlador estÃ© en ejecuciÃ³n:

```bash
kubectl get pods -n ingress-nginx | grep ingress
```

---

## ğŸ” 3. Instalar el controlador de Sealed Secrets

### Crear el namespace:
```bash
kubectl create namespace kube-system --dry-run=client -o yaml | kubectl apply -f -
```

### Instalar Sealed Secrets desde Bitnami:
```bash
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.26.0/controller.yaml
```

Verificar instalaciÃ³n:
```bash
kubectl get pods -n kube-system | grep sealed-secrets
```

### Exportar la clave pÃºblica (opcional, si vas a sellar secretos manualmente):
```bash
kubectl -n kube-system get secret -l sealedsecrets.bitnami.com/sealed-secrets-key   -o jsonpath="{.items[0].data['tls\.crt']}" | base64 --decode > pub-cert.pem
```

### Generar el SealedSecret
```bash
kubeseal --format yaml \
î‚¶ âœ” î‚¶ minikube ó±ƒ¾ î‚¶ 18:18:51 î‚°
  --controller-name=sealed-secrets-controller \
  --controller-namespace=kube-system \
  < secret-plain.yaml > base/secrets-sealed.yaml
```

---

## ğŸš€ 4. Instalar Argo CD

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

Verificar:
```bash
kubectl get pods -n argocd
```

> Puede tardar unos minutos hasta que todos los pods estÃ©n en **Running**.

---

## ğŸ”‘ 5. Obtener la contraseÃ±a de administrador

```bash
kubectl get secret argocd-initial-admin-secret -n argocd   -o jsonpath="{.data.password}" | base64 --decode; echo
```

Usuario: `admin`

---

## ğŸŒ 6. Exponer la UI de Argo CD

### OpciÃ³n A â€” Port-forward (simple)
```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```
Ingresar:  
ğŸ”— https://localhost:8080

Ignorar el aviso de certificado no seguro.

---

### OpciÃ³n B â€” Service con Minikube
```bash
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
minikube service argocd-server -n argocd
```

Esto abrirÃ¡ automÃ¡ticamente la interfaz web en tu navegador.

---

## ğŸ§­ 7. Iniciar sesiÃ³n en la UI

- **Username:** `admin`  
- **Password:** (contraseÃ±a obtenida en el paso anterior)

---

## ğŸ§± 8. Crear la aplicaciÃ³n GitOps desde la UI

1. En la UI â†’ **New App**
2. Completar los campos:

| Campo | Valor |
|-------|-------|
| **Application Name** | `intro-devops` |
| **Project** | `default` |
| **Sync Policy** | Manual |
| **Repository URL** | `https://github.com/tomignfirebreather/IntroDevOps_GitOps.git` |
| **Revision** | `main` |
| **Path** | `overlays/dev` |
| **Cluster** | `https://kubernetes.default.svc` |
| **Namespace** | `dev` |

3. Crear y luego hacer clic en **SYNC** para desplegar los recursos.

---

## ğŸ”„ 9. Verificar la sincronizaciÃ³n

En la UI:
- **Healthy âœ”ï¸** â†’ Todos los recursos desplegados correctamente.
- **OutOfSync âš ï¸** â†’ Cambios detectados en Git, requiere nuevo sync.
- **Error âŒ** â†’ Revisar logs del pod con error.

Desde la consola:
```bash
kubectl get all -n dev
```

---

## ğŸ§© 10. Acceso a la aplicaciÃ³n desplegada

Exponer los servicios localmente:

```bash
kubectl port-forward svc/frontend -n dev 5173:80
kubectl port-forward svc/backend -n dev 8000:8000
```

Luego acceder:
- Frontend â†’ [http://localhost:5173](http://localhost:5173)
- Backend â†’ [http://localhost:8000](http://localhost:8000)

---

## ğŸ§¹ 11. Limpieza del entorno (opcional)

Eliminar Argo CD y SealedSecrets:

```bash
kubectl delete ns argocd
kubectl delete -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.26.0/controller.yaml
```

---

## ğŸ§  Valor agregado
- **GitOps completo:** el repositorio Git define el estado deseado del clÃºster.  
- **AutomatizaciÃ³n CI/CD:** el pipeline actualiza imÃ¡genes y Argo CD aplica cambios.  
- **GestiÃ³n segura de secretos:** los `SealedSecrets` evitan exponer claves en GitHub.  
- **Monitoreo visual:** la UI permite observar el estado y sincronizaciÃ³n en tiempo real.  